<!DOCTYPE html>
<html>
<head>
  <title>Group Energy Storage Technology (ME4261) - Attendance</title>

  <!-- ðŸ” Access Control -->
  <script>
    if (sessionStorage.getItem("loggedIn") !== "yes") {
      window.location.href = "index.html";
    }
  </script>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: #f7f9fc;
    }

    /* ---------- TOP BARS ---------- */
    .title-bar {
      background: #0b3c5d;
      color: white;
      text-align: center;
      padding: 16px;
      font-size: 22px;
      font-weight: 600;
    }

    .sub-bar {
      background: #1b7f79;
      color: white;
      text-align: center;
      padding: 8px;
      font-size: 16px;
    }

    .blink {
      animation: blink 1.2s infinite;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }

    /* ---------- MAIN CONTENT ---------- */
    .container {
      padding: 18px;
      text-align: center;
    }

    /* ---------- STUDENT CARD ---------- */
    .student {
      background: white;
      border-radius: 10px;
      width: 260px;
      margin: 10px;
      display: inline-block;
      border: 2px solid #f57c00;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .info {
      padding: 10px;
      font-weight: 600;
      color: #263238;
    }

    .stats {
      background: #fff3e0;
      font-size: 13px;
      padding: 6px;
      color: #000;
    }

    /* ---------- ATTENDANCE BAR ---------- */
    .progress-container {
      height: 8px;
      background: #eceff1;
      border-radius: 5px;
      margin: 6px 10px 10px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }

    .p-green { background: #43a047; }
    .p-yellow { background: #fbc02d; }
    .p-orange { background: #f57c00; }
    .p-red { background: #e53935; }

    /* ---------- BUTTON ROW ---------- */
    .row {
      display: flex;
    }

    .btn {
      flex: 1;
      padding: 10px;
      cursor: pointer;
      font-weight: 600;
      border-top: 1px solid #ddd;
    }

    .present {
      background: #43a047;
      color: white;
    }

    .absent {
      background: #e53935;
      color: white;
    }

    /* ---------- LOGOUT ---------- */
    .logout-btn {
      background: #0b3c5d;
      color: white;
      padding: 10px 30px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .logout-btn:hover {
      background: #08324d;
    }
    .footer {
  margin-top: 40px;
  padding: 14px 10px;
  text-align: center;
  font-size: 13px;
  color: #455a64;
  background: #eef2f6;
  border-top: 1px solid #d0d7de;
}

.footer strong {
  color: #0b3c5d;
  font-weight: 600;
}

.footer span {
  font-size: 12px;
  color: #607d8b;
}
  </style>
</head>

<body>

<div class="title-bar">
  Group Energy Storage Technology (ME4261)
</div>

<div class="sub-bar">
  Attendance <span class="blink" id="dateBar"></span>
</div>

<div class="container">
  <div id="students">Loading...</div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbyMh-PhTqK8CTLji_J3MsFHpA1FAvn8sEyOh1WWGZ25TJwAQXX69R0rThkVlaQjFKa37Q/exec";
let students = [];

/* ---------- DATE ---------- */
const today = new Date().toLocaleDateString("en-GB", {
  day: "2-digit",
  month: "short",
  year: "numeric"
});
document.getElementById("dateBar").innerText = `(${today})`;

/* ---------- LOAD DATA ---------- */
Promise.all([
  fetch(URL).then(r => r.json()),
  fetch(URL + "?stats=true").then(r => r.json())
]).then(([list, stats]) => {

  const map = {};
  stats.forEach(s => map[s.roll] = s);

  students = list.map(s => ({
    ...s,
    attended: map[s.roll]?.attended || 0,
    total: map[s.roll]?.total || 0
  }));

  render();
});

/* ---------- HELPERS ---------- */
function getPercent(a, t) {
  return t ? ((a / t) * 100).toFixed(1) : 0;
}

function getBarClass(a, t) {
  const p = t ? (a / t) * 100 : 0;
  if (p >= 75) return "p-green";
  if (p >= 50) return "p-yellow";
  if (p >= 25) return "p-orange";
  return "p-red";
}

/* ---------- RENDER ---------- */
function render() {
  const c = document.getElementById("students");
  c.innerHTML = "";

  students.forEach((s, i) => {
    const d = document.createElement("div");
    d.className = "student";

    d.innerHTML = `
      <div class="info">${s.roll}<br>${s.name}</div>

      <div class="stats" id="stats-${i}">
        ${s.attended} / ${s.total} (${getPercent(s.attended, s.total)}%)
      </div>

      <div class="progress-container">
        <div class="progress-bar ${getBarClass(s.attended, s.total)}"
             id="bar-${i}"
             style="width:${getPercent(s.attended, s.total)}%">
        </div>
      </div>

      <div class="row">
        <div class="btn" onclick="mark(${i}, 'Present', this)">Present</div>
        <div class="btn" onclick="mark(${i}, 'Absent', this)">Absent</div>
      </div>
    `;
    c.appendChild(d);
  });
}

/* ---------- MARK ---------- */
function mark(i, status, el) {
  const s = students[i];

  const row = el.parentElement;
  row.children[0].className = "btn";
  row.children[1].className = "btn";
  el.classList.add(status === "Present" ? "present" : "absent");

  fetch(URL, {
    method: "POST",
    body: JSON.stringify({
      roll: s.roll,
      name: s.name,
      status: status
    })
  })
  .then(r => r.json())
  .then(res => {
    s.attended = res.attended;
    s.total = res.total;

    document.getElementById(`stats-${i}`).innerHTML =
      `${res.attended} / ${res.total} (${res.percent}%)`;

    const bar = document.getElementById(`bar-${i}`);
    bar.style.width = `${res.percent}%`;
    bar.className = `progress-bar ${getBarClass(res.attended, res.total)}`;
  });
}

/* ---------- LOGOUT ---------- */
function logout() {
  if (confirm("Do you want to close attendance and logout?")) {
    sessionStorage.removeItem("loggedIn");
    window.location.href = "index.html";
  }
}
</script>

<div style="text-align:center; margin:30px 0;">
  <button class="logout-btn" onclick="logout()">Close</button>
</div>
<div class="footer">
  <strong>Developed by Dr. Rajesh Akula</strong><br>
  <span>Â© 2026 Â· IIEST Shibpur</span>
</div>
</body>
</html>
